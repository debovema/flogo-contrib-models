# OpenTracing model for Flogo

This model adds OpenTracing instrumentation at Flogo engine level and tracers implementations
(Zipkin over HTTP or Kafka, Jaeger) to send traces generated by flows and activities to corresponding collectors.

For an introduction of concepts, read the [OpenTracing documentation](http://opentracing.io/documentation/). 

## Installation

### Flogo Web

This model is not available with the Flogo Web UI.

### Flogo CLI

#### Install the contribution

In the directory of a Flogo project (with a *flogo.json* file), run:

```bash
flogo install github.com/debovema/flogo-contrib-models/opentracing
```

#### Patch flogo-contrib and flogo-lib

**IMPORTANT**: This model requires some little updates in flogo-contrib and flogo-lib which are not yet merged into
TIBCOSoftware repositories. **This section will be removed after the merge**.
A script is provided to perform the operation.

In the directory of the Flogo project (with a *flogo.json* file), run:

```bash
sh -c "$(curl -fsSL https://raw.githubusercontent.com/debovema/flogo-contrib-models/master/opentracing/patch-vendor.sh)"
```

#### Build and run

Finally, build the application:
```bash
flogo build -e
```

The binary is ready to be run in ```./bin``` directory.

## Usage

For a basic usage with a Zipkin collector with HTTP transport, in the *flogo.json*
[generated by the ```flogo create```](https://github.com/TIBCOSoftware/flogo-cli#getting-started) command, replace

```json
  "resources": [
    {
      "id": "flow:sample_flow",
      "data": {
        "name": "SampleFlow",
        "tasks": [
          {
            "id": "log_2",
            "name": "Log Message",
            "description": "Simple Log Activity",
            "activity": {
              "ref": "github.com/TIBCOSoftware/flogo-contrib/activity/log",
              "input": {
                "message": "Simple Log",
                "flowInfo": "false",
                "addToFlow": "false"
              }
            }
          }
        ]
      }
    }
  ]
```

by 

```json
  "resources": [
    {
      "id": "flow:sample_flow",
      "data": {
        "name": "SampleFlow",
        "model": "github.com/square-it/flogo-contrib-models/opentracing",
        "attributes": [
          {
            "name": "opentracing-config",
            "type": "any",
            "value": {
              "implementation": "zipkin",
              "transport": "http",
              "endpoints": [
                "http://127.0.0.1:9411/api/v1/spans"
              ]
            }
          }
        ],
        "tasks": [
          {
            "id": "log_2",
            "name": "Log Message",
            "description": "Simple Log Activity",
            "activity": {
              "ref": "github.com/TIBCOSoftware/flogo-contrib/activity/log",
              "input": {
                "message": "Simple Log",
                "flowInfo": "false",
                "addToFlow": "false"
              }
            }
          }
        ]
      }
    }
  ]
```

Replace *127.0.0.1* by the actual IP of the Zipkin collector.

## Configuration

This model is enabled by the **model** field with a value of *github.com/square-it/flogo-contrib-models/opentracing*.

It can be configured by a JSON object in the *attributes* array (see [Usage](#usage)).
This object is an [attribute](https://github.com/TIBCOSoftware/flogo-lib/blob/master/core/data/attribute.go) of **type**
*any* with **name** *opentracing-config*.

The **value** is composed of three fields: 

* **implementation**: possible values are *zipkin* or *jaeger*
* **transport**: possible values are *http* (for all implementations) or *kafka* (for *zipkin* implementation only)
* **endpoints**: an array with a single endpoint (for HTTP transport) or multiple endpoints (for Kafka transport)

For instance:

```json
          {
            "name": "opentracing-config",
            "type": "any",
            "value": {
              "implementation": "zipkin",
              "transport": "http",
              "endpoints": [
                "http://127.0.0.1:9411/api/v1/spans"
              ]
            }
          }
```

## Collectors

This model can send traces to the following collectors:
* [Zipkin](https://zipkin.io/) over HTTP transport
* Zipkin over Kafka transport
* [Jaeger](https://www.jaegertracing.io/) over HTTP transport (TODO)

### Zipkin

#### HTTP transport

To start a single-node instance of a Zipkin server with HTTP transport, run:

```bash
docker run --name zipkin -d -p 9411:9411 openzipkin/zipkin
```

Use following configuration for the model:
```json
          {
            "name": "opentracing-config",
            "type": "any",
            "value": {
              "implementation": "zipkin",
              "transport": "http",
              "endpoints": [
                "http://127.0.0.1:9411/api/v1/spans"
              ]
            }
          }
```

If using Docker Machine, replace *127.0.0.1* by the IP of the active Docker Machine (usually *192.168.99.100*,
```echo $(docker-machine ip $(docker-machine active))``` to display the IP).

#### Kafka transport

For Kafka transport, start a single-node instance of a Kafka server with its Zookeeper:

```bash
mkdir -p /tmp/kafka
cd /tmp/kafka
curl -fsSL https://raw.githubusercontent.com/confluentinc/cp-docker-images/5.0.0-post/examples/kafka-single-node/docker-compose.yml -o docker-compose.yml
# uncomment if using Docker Machine
# sed -i "s|localhost:|$(docker-machine ip $(docker-machine active)):|" docker-compose.yml
docker-compose up -d
```

Then start a single-node instance of a Zipkin server with Kafka transport by running:

```bash
docker run --name zipkin -d -p 9411:9411 -e KAFKA_BOOTSTRAP_SERVERS=127.0.0.1:29092 openzipkin/zipkin
```

If using Docker Machine, run instead:
```bash
docker run --name zipkin -d -p 9411:9411 -e KAFKA_BOOTSTRAP_SERVERS=$(docker-machine ip $(docker-machine active)):29092 openzipkin/zipkin
```

Use following configuration for the model:
```json
          {
            "name": "opentracing-config",
            "type": "any",
            "value": {
              "implementation": "zipkin",
              "transport": "kafka",
              "endpoints": [
                "127.0.0.1:29092"
              ]
            }
          }
```

If using Docker Machine, replace *127.0.0.1* by the IP of the active Docker Machine (usually *192.168.99.100*,
```echo $(docker-machine ip $(docker-machine active))``` to display the IP).

### Jaeger

#### HTTP transport

TODO